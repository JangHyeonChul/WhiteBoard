<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/basic">
<head th:replace="fragements/header">
    <meta charset="UTF-8">
    <title>상세</title>
</head>
<body>
<div th:replace="fragements/bodyHeader"></div>
<div class="app-header-space"></div>
<div class="app-layout">
    <div class="app-member-content-header"><i class="fas fa-lightbulb"></i> 게시글 상세</div>

    <table border="1px">
        <thead>
        <tr>
            <th>UID</th>
            <th>ID</th>
            <th>Title</th>
            <th>Content</th>
            <th>Created At</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td th:text="${board.uid}"></td>
            <td th:text="${board.created_user}"></td>
            <td th:text="${board.title}"></td>
            <td th:text="${board.content}"></td>
            <td th:text="${board.created_at}"></td>
        </tr>
        </tbody>
    </table>

    <div>
        <h3>댓글 작성</h3>
        <form id="comment-form">
            <label for="created_user">작성자</label>
            <input type="text" id="created_user" name="created_user"><br>

            <label for="comment">내용</label>
            <textarea id="comment" name="comment"></textarea><br>

            <button type="submit">작성하기</button>
        </form>
    </div>

    <div>
        <h3>댓글 목록</h3>
        <ul id="comment-list"></ul>
    </div>
</div>
</div>
<script>
    const boardUid = new URLSearchParams(window.location.search).get('uid');

    const commentForm = document.querySelector('#comment-form');
    const commentList = document.querySelector('#comment-list');
    const commentDto = {
        uid : '',
        mother_uid:boardUid,
        comment : '',
        created_user: '',
        created_at: null,
        updated_at: null,
        is_del : 0
    };

    commentForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const createdUser = commentForm.elements['created_user'].value;
        const comment = commentForm.elements['comment'].value;


        // 댓글 작성 ajax
        fetch(`/board/comment?boardUid=${boardUid}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ created_user: createdUser, comment: comment }),
        })
            .then(response => response.json())
            .then(data => {

                const newComment = document.createElement('li');
                newComment.textContent = data.created_user + ' - ' + data.comment;


                const deleteButton = document.createElement('button');
                deleteButton.textContent = '삭제';
                deleteButton.classList.add('delete-comment'); // add class
                deleteButton.dataset.commentUid = data.uid; // use data-* attributes
                newComment.appendChild(deleteButton);


                const editButton = document.createElement('button');
                editButton.textContent = '수정';
                editButton.classList.add('edit-comment'); // add class
                editButton.dataset.commentUid = data.uid; // use data-* attributes
                newComment.appendChild(editButton);

                commentList.appendChild(newComment);


                commentForm.elements['created_user'].value = '';
                commentForm.elements['comment'].value = '';
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });



    // 화면 생성 시 코멘트 리스트를 불러오기
    fetch(`/board/comment?boardUid=${boardUid}`)
        .then(response => response.json())
        .then(data => {
            // 기존 댓글 초기화
            commentList.innerHTML = '';

            data.forEach(comment => {
                const newComment = document.createElement('li');
                newComment.textContent = comment.created_user + ' - ' + comment.comment;

                // 삭제 버튼 추가
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '삭제';
                deleteButton.classList.add('delete-comment'); // 클래스 추가
                deleteButton.dataset.commentUid = comment.uid; // data-* attribute 사용
                newComment.appendChild(deleteButton);

                // 수정 버튼 추가
                const editButton = document.createElement('button');
                editButton.textContent = '수정';
                editButton.classList.add('edit-comment'); // 클래스 추가
                editButton.dataset.commentUid = comment.uid; // data-* attribute 사용
                newComment.appendChild(editButton);

                commentList.appendChild(newComment);
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });


    function deleteComment(commentUid) {
        if (confirm('정말로 삭제하시겠습니까?')) {
            fetch(`/board/comment/delete?commentUid=${commentUid}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                    {
                        uid: commentUid,
                }),
            })
                .then(response => {
                    if (response.status >= 200 && response.status < 300) {
                        removeCommentFromList(commentUid);
                    } else {
                        alert('댓글 삭제에 실패하였습니다.' + response.statusText);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('댓글 삭제에 실패하였습니다. 오류메시지 : ' + error);
                });
        }
    }

    // 댓글 리스트 컨테이너에 클릭 이벤트 핸들러 추가
    commentList.addEventListener('click', (event) => {
        const target = event.target;

        // 삭제 버튼 클릭 시
        if (event.target.classList.contains('delete-comment')) {
            const commentUid = target.dataset.commentUid;
            deleteComment(commentUid);
        }

        // 수정 버튼 클릭 시
        if (target.dataset.commentUid && target.textContent === '수정') {
            const commentUid = target.dataset.commentUid;
            openEditModal(commentUid);
        }
    });

    function removeCommentFromList(commentUid) {
        const comment = document.querySelector(`li[data-comment-uid="${commentUid}"]`);
        if (comment) {
            comment.parentNode.removeChild(comment);
        }
    }
</script>
</body>
</html>